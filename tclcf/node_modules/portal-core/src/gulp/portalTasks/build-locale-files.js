module.exports = function(gulp, config) {
    var _ = require('lodash')
    var gulpData = require('gulp-data')
    var gulpif = require('gulp-if')
    var gutil = require('gulp-util')
    var yaml = require('js-yaml')
    var es = require('event-stream')
    var mergeJson = require('gulp-merge-json')
    var path = require('path')

    var streams = _.map(config.localeBundles, bundle => {
        return gulp.src(bundle.files)
            .pipe(gulpif(
                file => /\.yaml$/.test(file.path),
                gulpData((file, cb) => {
                    file.contents = new Buffer(JSON.stringify(
                        yaml.load(String(file.contents.toString('utf8')))
                    ))
                    cb(null, file)
                })
            ))
            .pipe(mergeJson(`${bundle.locale}.json`, (result, file) => {
                let item = path.basename(file.path, '.yaml')
                let module = path.basename(path.resolve(file.path, '../../..'))
                if (module !== 'main') {
                    return {
                        [module]: {
                            [item]: result
                        }
                    }
                } else {
                    return {
                        [item]: result
                    }
                }
            }))
            .pipe(gulp.dest(config.dist))
            .on('error', err => gutil.log(gutil.colors.red('Locale file error:'), err.message))
    })

    return es.merge(streams)
}
