module.exports = function(gulp, config) {
    const _ = require('lodash')
    const es = require('event-stream')
    const gulpif = require('gulp-if')
    const rename = require('gulp-rename')
    const flatten = require('gulp-flatten')
    const fs = require('fs-extra')

    //build a modules json so we know what modules are included
    var changelogs = fs.readdirSync('node_modules')
        .filter(file => /^.+portal-modules$/.test(file))
    fs.ensureDirSync(config.dist)
    fs.writeFileSync(`${config.dist}/modules.json`, JSON.stringify(changelogs, null, 2))

    const streams = _.map(config.staticFiles, staticFile => {
        return gulp.src(staticFile.files, {base: '.'})
            .pipe(gulpif(_.isFunction(staticFile.rename), rename(staticFile.rename)))
            .pipe(flatten())
            .pipe(gulp.dest(`${config.dist}/${staticFile.dest}`))
    })

    return es.merge(streams)
}
