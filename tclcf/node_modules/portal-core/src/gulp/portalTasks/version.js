var gitrev = require('git-rev')
var path = require('path')
var RevAll = require('gulp-rev-all')
var gutil = require('gulp-util')

module.exports = function(gulp, config, done) {
    gitrev.short(function(sha) {
        gutil.log(gutil.colors.yellow('Using sha:'), sha)
        var revAll = new RevAll({
            dontSearchFile: [
                'vendor.js',
                'vendor.css',
                /angular-i18n\/\w+-\w+\.js/i,
                /\w+-\w+\.json/i
            ],
            transformFilename: file => {
                var ext = path.extname(file.path)
                return `${path.basename(file.path, ext)}.${sha}${ext}`
            },
            dontGlobal: config.ignoreRevAll
        })

        gulp.src('./dist/**/*')
            .pipe(revAll.revision())
            .pipe(gulp.dest(config.stage))

        done()
    })
}
