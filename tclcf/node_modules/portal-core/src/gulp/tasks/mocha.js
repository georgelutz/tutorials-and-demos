module.exports = function(gulp, config, done) {
    var mocha = require('gulp-mocha')
    var istanbul = require('gulp-istanbul')
    var isparta = require('isparta')
    var fs = require('fs-extra')

    if (fs.existsSync('./src/test')) {
        gulp.src(config.jsMain)
            .pipe(istanbul({ // Covering files
                instrumenter: isparta.Instrumenter,
                includeUntested: true
            }))
            .pipe(istanbul.hookRequire()) // Force `require` to return covered files
            .on('finish', () => {
                gulp.src(config.jsTest, {read: false})
                    .pipe(mocha(config.mochaConfig))
                    .pipe(istanbul.writeReports({
                        dir: './coverage',
                        reportOpts: {dir: './coverage'},
                        reporters: ['html', 'cobertura']
                    }))
                    .on('end', done)
            })
    } else {
        done()
    }
}
