var _ = require('lodash')

module.exports = /* @ngInject */
    function($log, $translate, Restangular, dialogService, toastService) {
        let translations = {}
        $translate([
            'permission.permissionEdit.error'
        ]).then(translated => translations = translated)

        Restangular.addElementTransformer('permissions', false, permission => {
            if (permission.id) {
                permission.key = permission.id
            }

            if (permission.name) {
                permission.displayName = _.startCase(permission.name.replace(/^ROLE_/, '').toLowerCase())
            }

            permission.confirmDelete = event => {
                const confirmDeleteOptions = {
                    entityName: permission.displayName,
                    targetEvent: event
                }

                return dialogService.showConfirmDelete(confirmDeleteOptions)
                    .then(() => permission.remove())
                    .then(() => {
                        permission.deleted = true
                        return permission
                    })
                    .catch(err => {
                        if (err) {
                            $log.error('Error deleting permission', err)
                            toastService.show(translations['permission.permissionEdit.error'], {theme: 'warn'})
                        }
                    })
            }

            return permission
        })
    }
