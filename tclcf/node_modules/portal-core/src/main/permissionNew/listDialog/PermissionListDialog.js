const _ = require('lodash')

require('./permissionListDialog.scss')

module.exports = {
    template: require('./permissionListDialog.html'),
    clickOutsideToClose: true,
    escapeToClose: true,
    controllerAs: '$ctrl',
    controller: class PermissionListDialog {
        /* @ngInject */
        constructor($filter, $mdDialog, $translate, assignee, listService, permissions) {
            this.$filter = $filter
            this.$mdDialog = $mdDialog
            this.$translate = $translate
            this.assignee = assignee
            this.listService = listService
            this.permissions = permissions

            this.init = this.onInit()
        }

        onInit() {
            this.context = 'permissionListDialog'

            this.toolbarTitle = 'permissionNew.permissionList.title'

            this.cols = [
                {
                    name: 'permissionNew.permissionList.cols.name',
                    path: 'name'
                },
                {
                    name: 'permissionNew.permissionList.cols.actions',
                    template: '<modal-action-icons row="row"></modal-action-icons>'
                }
            ]

            this.staticResults = _.map(this.permissions, permission => ({
                icon: 'person',
                name: permission.permissionName,
                type: 'static',
                key: permission.permissionId,
                term: permission.permissionName,
                param: 'permission'
            }))

            this.rows = this.permissions

            this.total = _.size(this.rows)

            this.toolbarOptions = {
                filterButton: true
            }

            this.tableOptions = {
                rowSelect: true
            }

            this.paginationOptions = {
                boundaryLinks: true,
                pageSizes: [10, 25, 50]
            }

            this.chipFilterOptions = {
                staticResults: this.staticResults
            }

            this.listService.page = 1
            this.listService.pageSize = 10

            this.params = {
                page: this.listService.page - 1,
                pageSize: this.listService.pageSize
            }

            this.getRows()

            return this.loadTranslations()
        }

        loadTranslations() {
            let translations = [
                'permissionNew.permissionListDialog.subheader',
                'permissionNew.permissionListDialog.instructions'
            ]

            return this.$translate(translations)
                .then(res => this.res = res)
        }

        getRows() {
            let start = this.params.page * this.params.pageSize
            let end = start + this.params.pageSize
            this.rows = _.slice(this.permissions, start, end)
        }

        changePage(params) {
            this.params.page = params.page
            this.params.pageSize = params.pageSize

            this.listService.page = params.page + 1
            this.listService.pageSize = params.pageSize

            return this.getRows()
        }

        checkChipsCustom() {
            return !!this.chips
        }

        clearChipsCustom() {
            this.getRows()
            return _.remove(this.chips)
        }

        chipsUpdated(params) {
            if (_.get(params.selectedChips, 'length')) {
                let results = _.reduce(params.selectedChips, (result, chip) => {
                    let found = this.$filter('filter')(this.permissions, chip.term)
                    result.push(found)
                    return result
                }, [])

                //find the results that match all chips and put them first in the results
                //then put the rest of the results in the list - this should relatively
                //simulate how elastic search returns search results
                this.rows = _.uniq(_.intersection(...results).concat(_.flatten(results)))

                this.total = _.size(this.rows)
            } else {
                this.getRows()

                this.total = _.size(this.permissions)
            }

            //stop the state reload from happening
            return true
        }

        cancel() {
            this.$mdDialog.cancel()
        }

        save() {
            let permissions = _.filter(this.permissions, {active: true})
            this.$mdDialog.hide(permissions)
        }
    }
}
