<page-header ng-if="$ctrl.user.adding" title="{{'user.userEditProfile.title' | translate}}"></page-header>

<standard-card class="user-edit-container">
    <form name="$ctrl.form" layout="column" ng-submit="$ctrl.form.$valid && $ctrl.submit()" novalidate>
        <md-subheader class="md-no-sticky user-subheader">
            {{'user.userEditProfile.account' | translate}}
        </md-subheader>

        <md-input-container ng-if="!$ctrl.edit">
            <label translate="user.common.email"></label>
            <input type="email"
                   ng-model="$ctrl.user.userEmails[0]['emailAddress']"
                   name="email"
                   required/>
            <ng-messages for="$ctrl.form.email.$error" md-auto-hide="false" ng-if="$ctrl.form.email.$touched">
                <ng-message when="required">{{'user.common.email_required' | translate}}</ng-message>
                <ng-message when="email">{{'user.common.email_invalid' | translate}}</ng-message>
                <field-error field="email"></field-error>
                <field-error field="username"></field-error>
            </ng-messages>
        </md-input-container>

        <md-input-container ng-show="$ctrl.edit">
            <label translate="user.common.email"></label>
            <input type="email"
                   ng-model="$ctrl.user.userEmails[0]['emailAddress']"
                   name="email"
                   disabled="true"/>
            <ng-messages for="$ctrl.verifyMessage">
                <ng-message when="notVerified">{{'user.userEditProfile.email_unverified' | translate}}
                </ng-message>
            </ng-messages>
        </md-input-container>

        <div layout="row" layout-xs="column">
            <md-input-container flex-gt-xs="50">
                <label translate="user.userEditProfile.first_name"></label>
                <input type="text"
                       ng-model="$ctrl.user.firstName"
                       name="firstName"
                       md-minlength=2
                       md-maxlength=15
                       required/>
                <ng-messages for="$ctrl.form.firstName.$error" md-auto-hide="false" ng-if="$ctrl.form.firstName.$touched">
                    <ng-message when="required">{{'user.userEditProfile.first_name_required' | translate}}
                    </ng-message>
                    <ng-message when="md-minlength">{{'user.userEditProfile.first_name_min' | translate}}
                    </ng-message>
                    <ng-message when="md-maxlength">{{'user.userEditProfile.first_name_max' | translate}}
                    </ng-message>
                    <field-error field="firstName"></field-error>
                </ng-messages>
            </md-input-container>

            <md-input-container flex-gt-xs="50">
                <label translate="user.userEditProfile.last_name"></label>
                <input type="text"
                       ng-model="$ctrl.user.lastName"
                       name="lastName"
                       required/>
                <ng-messages for="$ctrl.form.lastName.$error" md-auto-hide="false" ng-if="$ctrl.form.lastName.$touched">
                    <ng-message when="required">{{'user.userEditProfile.last_name_required' | translate}}
                    </ng-message>
                    <field-error field="lastName"></field-error>
                </ng-messages>
            </md-input-container>
        </div>

        <div layout="row" layout-xs="column">
            <md-input-container flex-gt-xs="50">
                <label translate="user.userEditProfile.phone"></label>
                <input phone-number
                       type="text"
                       ng-model="$ctrl.user.userPhones[0]['phone']"
                       name="phone"
                       required
                       ng-pattern="/^\(?\d{3}\)?\s?\d{3}-?\d{4}$/"/>

                <ng-messages for="$ctrl.form.phone.$error" md-auto-hide="false" ng-if="$ctrl.form.phone.$touched">
                    <ng-message when="required">{{'user.userEditProfile.phone_required' | translate}}</ng-message>
                    <ng-message when="pattern">{{'user.userEditProfile.phone_min' | translate}}</ng-message>
                </ng-messages>
            </md-input-container>

            <md-input-container flex-gt-xs="50">
                <label translate="user.userEditProfile.extension"></label>
                <input type="text"
                       ng-model="$ctrl.user.userPhones[0]['extension']"
                       name="extension"/>
            </md-input-container>
        </div>

        <div layout="column" layout-padding>
            <md-subheader class="md-no-sticky user-subheader">
                {{'user.userEditProfile.preferences' | translate}}
            </md-subheader>

            <md-checkbox ng-model="$ctrl.sidenavCollapse" class="md-primary">{{'user.userEdit.side_nav_pref' | translate}}</md-checkbox>

            <md-input-container ng-hide="!$ctrl.canChangePassword">
                <label translate="user.userEditProfile.locale_label"></label>
                <md-select ng-model="$ctrl.locale">
                    <md-option ng-value="loc" ng-repeat="loc in $ctrl.locales">{{loc.name}}</md-option>
                </md-select>
            </md-input-container>

            <md-input-container>
                <label translate="user.userEditProfile.units_of_distance_label"></label>
                <md-select ng-model="$ctrl.distanceUnit">
                    <md-option ng-value="unitOfDistance" ng-repeat="unitOfDistance in $ctrl.unitsOfDistance">{{unitOfDistance.name | translate}}</md-option>
                </md-select>
            </md-input-container>

            <md-input-container>
                <label translate="user.userEditProfile.units_of_volume_label"></label>
                <md-select ng-model="$ctrl.volumeUnit">
                    <md-option ng-value="unitOfVolume" ng-repeat="unitOfVolume in $ctrl.unitsOfVolume">{{unitOfVolume.name | translate}}</md-option>
                </md-select>
            </md-input-container>

            <md-input-container>
                <label translate="user.userEditProfile.units_of_temperature_label"></label>
                <md-select ng-model="$ctrl.temperatureUnit">
                    <md-option ng-value="unitOfTemperature" ng-repeat="unitOfTemperature in $ctrl.unitsOfTemperature">{{unitOfTemperature.name | translate}}</md-option>
                </md-select>
            </md-input-container>

            <md-input-container>
                <label translate="user.userEditProfile.units_of_pressure_label"></label>
                <md-select ng-model="$ctrl.pressureUnit">
                    <md-option ng-value="unitOfPressure" ng-repeat="unitOfPressure in $ctrl.unitsOfPressure">{{unitOfPressure.name | translate}}</md-option>
                </md-select>
            </md-input-container>

            <md-input-container>
                <label translate="user.userEditProfile.units_of_mass_label"></label>
                <md-select ng-model="$ctrl.massUnit">
                    <md-option ng-value="unitOfMass" ng-repeat="unitOfMass in $ctrl.unitsOfMass">{{unitOfMass.name | translate}}</md-option>
                </md-select>
            </md-input-container>
        </div>

        <!-- Passwords -->
        <div layout="column" ng-if="!$ctrl.edit && $ctrl.canCreateUserWithPassword">
            <md-subheader class="md-no-sticky">
                {{'user.userEditProfile.password' | translate}}
            </md-subheader>
            <md-input-container>
                <label translate="user.userEditProfile.new_password"></label>
                <input type="password"
                       name="newPassword"
                       ng-model="$ctrl.newPassword"
                       ng-change="$ctrl.compareFields()"/>
                <ng-messages for="$ctrl.form.newPassword.$error" md-auto-hide="false" ng-if="$ctrl.form.newPassword.$touched">
                    <ng-message when="different">{{'user.common.password_differ' | translate}}</ng-message>
                    <ng-message when="empty">{{'user.common.new_password_required' | translate}}</ng-message>
                    <field-error field="password"></field-error>
                </ng-messages>
            </md-input-container>

            <md-input-container>
                <label translate="user.common.conf_password"></label>
                <input type="password"
                       name="confirmPassword"
                       ng-model="$ctrl.confirmPassword"
                       ng-change="$ctrl.compareFields()"/>

                <ng-messages for="$ctrl.form.confirmPassword.$error"
                             md-auto-hide="false"
                             ng-if="$ctrl.form.confirmPassword.$touched">
                    <ng-message when="fieldEquality">{{'user.common.password_not_eq' | translate}}
                    </ng-message>
                    <field-error field="password"></field-error>
                </ng-messages>
            </md-input-container>
        </div>

        <div id="org-group" ng-if="!$ctrl.editingSelf" layout="column">
            <md-subheader class="md-no-sticky">
                {{'user.userEditProfile.organization' | translate}}
            </md-subheader>

            <!-- organization type -->
            <md-input-container class="user-organizationType-select">
                <label translate="user.userEditProfile.org_type"></label>
                <md-select ng-model="$ctrl.curOrgType"
                           required
                           name="curOrgType"
                           ng-change="$ctrl.cleanOrg()"
                           ng-disabled="$ctrl.editingSelf || $ctrl.editingPFMUser">
                    <md-option ng-value="orgType" ng-repeat="orgType in $ctrl.userOrgTypes">{{orgType.displayName}}
                    </md-option>
                </md-select>
                <ng-messages for="$ctrl.form.curOrgType.$error" md-auto-hide="false" ng-if="$ctrl.form.curOrgType.$touched">
                    <ng-message when="required">{{'user.userEditProfile.org_type_required' | translate}}</ng-message>
                </ng-messages>
            </md-input-container>

            <!-- organization name -->
            <md-autocomplete
                             required
                             md-autoselect="true"
                             ng-if="$ctrl.curOrgType"
                             ng-disabled="$ctrl.editingSelf || $ctrl.editingPFMUser"
                             md-selected-item-change="$ctrl.organizationChanged()"
                             md-input-name="organization"
                             md-no-cache="true"
                             md-select-on-match="true"
                             md-delay="300"
                             md-min-length="0"
                             md-selected-item="$ctrl.organization"
                             md-search-text="$ctrl.orgNameSearchText"
                             md-items="item in $ctrl.searchOrgList($ctrl.orgNameSearchText)"
                             md-item-text="item.name"
                             md-floating-label="{{'user.userEditProfile.org_name' | translate}}">
                <md-item-template>
                    <span md-highlight-text="$ctrl.orgNameSearchText" md-highlight-flags="gi">
                        {{item.name}}
                    </span>
                </md-item-template>
                <ng-messages for="$ctrl.form.organization.$error" md-auto-hide="false" ng-if="$ctrl.form.organization.$touched">
                    <ng-message when="required">{{'user.userEditProfile.org_name_required' | translate}}</ng-message>
                </ng-messages>
            </md-autocomplete>

            <!-- user role -->
            <md-autocomplete
                             required
                             md-autoselect="true"
                             ng-if="$ctrl.curOrgType"
                             ng-disabled="$ctrl.editingSelf"
                             md-input-name="userRole"
                             md-no-cache="true"
                             md-select-on-match="true"
                             md-delay="300"
                             md-min-length="0"
                             md-selected-item="$ctrl.userRole"
                             md-search-text="$ctrl.userRoleSearchText"
                             md-items="item in $ctrl.searchRoleList($ctrl.userRoleSearchText)"
                             md-item-text="item.name"
                             md-floating-label="{{'user.userEditProfile.usr_role' | translate}}">
                <md-item-template>
                    <span md-highlight-text="$ctrl.userRoleSearchText" md-highlight-flags="gi">
                        {{item.name}}
                    </span>
                </md-item-template>
                <ng-messages for="$ctrl.form.userRole.$error" md-auto-hide="false" ng-if="$ctrl.form.userRole.$touched">
                    <ng-message when="required">{{'user.userEditProfile.usr_role_required' | translate}}</ng-message>
                    <div ng-repeat="license in $ctrl.form.userRole.licenses"
                         translate="user.userEditProfile.licenses"
                         translate-compile
                         translate-values="{ seatLimit: '{{license.seatLimit}}', seatsUsed: '{{license.seatsUsed}}', app: '{{license.application.name}}' }">
                    </div>
                </ng-messages>
            </md-autocomplete>
        </div>

        <div layout="column">
            <md-subheader class="md-no-sticky">{{'user.userEditProfile.status_quote' | translate}}
            </md-subheader>
            <md-checkbox ng-model="$ctrl.user.status" ng-true-value="1" ng-false-value="0" class="md-primary">
                {{($ctrl.user.status ? 'user.common.status_active' : 'user.common.status_inactive') | translate}}
            </md-checkbox>
            <md-checkbox ng-model="$ctrl.user.userEmails[0]['verified']" class="md-primary" ng-disabled="!$ctrl.canVerifyUsers">
                {{($ctrl.user.userEmails[0]['verified'] ? 'user.userEditProfile.email_verified' :
                'user.userEditProfile.email_not_verified') | translate}}
            </md-checkbox>
        </div>

        <br>

        <div ng-hide="$ctrl.needsConfirmation" layout="row" layout-align="end center">
            <md-button
                    ng-if="!$ctrl.editingSelf && !$ctrl.user.adding && $ctrl.currentUser.hasPermission('ROLE_USER_DELETE')"
                    type="button"
                    class="md-raised md-warn"
                    ng-click="$ctrl.confirmDelete($event)">{{'core.common.form.delete' | translate}}
            </md-button>

            <span flex></span>

            <md-button
                    ng-if="!$ctrl.editingSelf"
                    type="button"
                    class="md-raised"
                    href="#/nav/user/list/">
                {{'core.common.form.cancel' | translate}}
            </md-button>
            <md-button
                    ng-if="$ctrl.editingSelf"
                    type="button"
                    class="md-cancel"
                    href="#/nav/welcome">
                {{'core.common.form.cancel' | translate}}
            </md-button>

            <md-button
                    md-primary
                    type="submit">
                {{'core.common.form.save' | translate}}
            </md-button>
        </div>
    </form>
</standard-card>
