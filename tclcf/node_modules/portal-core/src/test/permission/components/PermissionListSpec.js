const _ = require('lodash')
describe('PermissionList', () => {
    let $state
    let permissions
    let component
    let currentUser
    let ctrl
    let $filter
    let filter
    let listService

    beforeEach(() => {
        currentUser = {}
        currentUser.hasPermission = sinon.stub()
        $state = {}
        permissions = [
            {displayName: 'name1', key: 'key1'},
            {displayName: 'name2', key: 'key2'}
        ]
        _.set($state, '$current.locals.globals', {
            permissions, currentUser
        })
        $state.go = sinon.stub()

        filter = sinon.stub()
        $filter = sinon.stub().withArgs('filter').returns(filter)

        listService = {
            page: 1,
            pageSize: 10
        }

        component = require('../../../main/permission/components/PermissionList')
        ctrl = new component.controller($filter, $state, listService)

        ctrl.$onInit()
    })

    it('should initialize', () => {
        ctrl.permissions.should.equal(permissions)
        ctrl.staticResults.should.deep.equal([
            {
                icon: 'lock_outline',
                name: 'name1',
                type: 'static',
                key: 'key1',
                term: 'key1',
                param: 'app'
            }, {
                icon: 'lock_outline',
                name: 'name2',
                type: 'static',
                key: 'key2',
                term: 'key2',
                param: 'app'
            }
        ])
    })

    it('should not filter with no chips', () => {
        let chips = {
            selectedChips: []
        }
        ctrl.chipsUpdated(chips).should.be.true

        ctrl.rows.should.deep.equal(ctrl.permissions)
        filter.should.not.have.been.called
    })

    it('should work with a single chip', () => {
        let chips = {
            selectedChips: [
                {term: 'myTerm'}
            ]
        }
        filter.withArgs(ctrl.rows, 'myTerm').returns(['abc', 'def'])
        ctrl.chipsUpdated(chips).should.be.true

        ctrl.rows.should.deep.equal(['abc', 'def'])
    })

    it('should work with a multiple chips', () => {
        let chips = {
            selectedChips: [
                {term: 'myTerm1'},
                {term: 'myTerm2'}
            ]
        }

        filter.withArgs(ctrl.rows, 'myTerm1').returns(['abc', 'def'])
        filter.withArgs(ctrl.rows, 'myTerm2').returns(['def', 'ghi'])

        ctrl.chipsUpdated(chips).should.be.true

        ctrl.rows.should.deep.equal(['def', 'abc', 'ghi'])
    })
})
